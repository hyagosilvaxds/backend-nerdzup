# üîî Sistema de Notifica√ß√µes - Nerdzup Backend

## Vis√£o Geral

O sistema de notifica√ß√µes permite enviar, gerenciar e receber notifica√ß√µes em tempo real para usu√°rios da plataforma. Suporta diferentes tipos de notifica√ß√µes, prioridades e a√ß√µes espec√≠ficas.

## üìä Tipos de Notifica√ß√£o

### Service Requests
- `SERVICE_REQUEST_APPROVED` - Solicita√ß√£o de servi√ßo aprovada
- `SERVICE_REQUEST_REJECTED` - Solicita√ß√£o de servi√ßo rejeitada  
- `SERVICE_REQUEST_ASSIGNED` - Solicita√ß√£o atribu√≠da a funcion√°rios
- `SERVICE_REQUEST_COMPLETED` - Servi√ßo conclu√≠do

### Tasks & Workflow
- `TASK_ASSIGNED` - Tarefa atribu√≠da
- `TASK_COMPLETED` - Tarefa conclu√≠da
- `TASK_DUE_SOON` - Tarefa pr√≥xima do prazo
- `TASK_PROGRESS_UPDATE` - Avan√ßo nas tarefas

### Campaigns
- `CAMPAIGN_UPDATE` - Atualiza√ß√µes gerais de campanhas
- `CAMPAIGN_CREATED` - Nova campanha criada
- `CAMPAIGN_COMPLETED` - Campanha finalizada

### File Management
- `LIBRARY_FILE_ADDED` - Arquivo adicionado √† biblioteca
- `LIBRARY_FILE_REMOVED` - Arquivo removido da biblioteca
- `LIBRARY_FILE_UPDATED` - Arquivo da biblioteca atualizado

### Security & Account
- `PASSWORD_CHANGED` - Senha alterada com sucesso
- `ACCOUNT_LOCKED` - Conta bloqueada por seguran√ßa
- `LOGIN_ATTEMPT` - Tentativa de login suspeita

### Communication
- `CHAT_MESSAGE` - Nova mensagem no chat
- `CHAT_MESSAGE_MENTION` - Men√ß√£o em mensagem do chat

### Billing
- `PAYMENT_SUCCESS` - Pagamento processado com sucesso
- `PAYMENT_FAILED` - Falha no pagamento
- `SUBSCRIPTION_EXPIRED` - Assinatura expirada
- `SUBSCRIPTION_RENEWED` - Assinatura renovada
- `CREDITS_LOW` - Cr√©ditos baixos

### System
- `SYSTEM_ANNOUNCEMENT` - An√∫ncio do sistema
- `SYSTEM_MAINTENANCE` - Manuten√ß√£o programada
- `GENERAL` - Notifica√ß√£o geral

## üìà N√≠veis de Prioridade

- `LOW` - Baixa prioridade
- `MEDIUM` - Prioridade m√©dia (padr√£o)
- `HIGH` - Alta prioridade 
- `URGENT` - Urgente

---

## üéØ Endpoints da API

### **Para Usu√°rios (Autenticados)**

#### Get My Notifications
**GET** `/notifications`

**Permiss√µes**: Usu√°rios autenticados

##### Query Parameters
```
type?: NotificationType          // Filtrar por tipo
priority?: NotificationPriority  // Filtrar por prioridade  
isRead?: boolean                 // Filtrar por status de leitura
page?: number = 1                // P√°gina (pagina√ß√£o)
limit?: number = 20              // Itens por p√°gina
search?: string                  // Busca em t√≠tulo/mensagem
```

##### Response (200 OK)
```json
{
  "notifications": [
    {
      "id": "notif_123",
      "type": "SERVICE_REQUEST_APPROVED",
      "title": "Solicita√ß√£o de Servi√ßo Aprovada",
      "message": "Sua solicita√ß√£o para o projeto \"Website E-commerce\" foi aprovada e est√° sendo processada.",
      "data": {
        "serviceRequestId": "req_456",
        "projectName": "Website E-commerce"
      },
      "isRead": false,
      "actionUrl": "/service-requests/req_456",
      "priority": "HIGH",
      "expiresAt": null,
      "createdAt": "2024-01-15T10:30:00.000Z",
      "updatedAt": "2024-01-15T10:30:00.000Z",
      "recipient": {
        "id": "user_789",
        "email": "cliente@exemplo.com",
        "role": "CLIENT",
        "profilePhoto": "https://cdn.nerdzup.com/profile.jpg"
      }
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 5,
    "totalPages": 1
  }
}
```

#### Get Notification Stats
**GET** `/notifications/stats`

**Permiss√µes**: Usu√°rios autenticados

##### Response (200 OK)
```json
{
  "total": 15,
  "unread": 3,
  "read": 12,
  "byType": {
    "SERVICE_REQUEST_APPROVED": 5,
    "PAYMENT_SUCCESS": 3,
    "TASK_ASSIGNED": 4,
    "CREDITS_LOW": 3
  },
  "byPriority": {
    "HIGH": 2,
    "MEDIUM": 1,
    "LOW": 0
  }
}
```

#### Get Single Notification
**GET** `/notifications/:id`

**Permiss√µes**: Usu√°rios autenticados (apenas pr√≥prias notifica√ß√µes)

##### Response (200 OK)
```json
{
  "id": "notif_123",
  "type": "SERVICE_REQUEST_APPROVED",
  "title": "Solicita√ß√£o de Servi√ßo Aprovada",
  "message": "Sua solicita√ß√£o para o projeto \"Website E-commerce\" foi aprovada.",
  "data": {
    "serviceRequestId": "req_456",
    "projectName": "Website E-commerce"
  },
  "isRead": false,
  "actionUrl": "/service-requests/req_456",
  "priority": "HIGH",
  "expiresAt": null,
  "createdAt": "2024-01-15T10:30:00.000Z",
  "updatedAt": "2024-01-15T10:30:00.000Z",
  "recipient": {
    "id": "user_789",
    "email": "cliente@exemplo.com",
    "role": "CLIENT",
    "profilePhoto": "https://cdn.nerdzup.com/profile.jpg"
  }
}
```

#### Mark Notification as Read
**PATCH** `/notifications/:id/read`

**Permiss√µes**: Usu√°rios autenticados (apenas pr√≥prias notifica√ß√µes)

##### Response (200 OK)
```json
{
  "id": "notif_123",
  "isRead": true,
  "updatedAt": "2024-01-15T11:00:00.000Z"
}
```

#### Mark Multiple/All Notifications as Read
**PATCH** `/notifications/mark-all-read`

**Permiss√µes**: Usu√°rios autenticados

##### Request Body
```json
{
  "notificationIds": ["notif_123", "notif_456"]  // Opcional - se vazio, marca todas como lidas
}
```

##### Response (200 OK)
```json
{
  "count": 2,
  "message": "2 notification(s) marked as read"
}
```

#### Delete Notification
**DELETE** `/notifications/:id`

**Permiss√µes**: Usu√°rios autenticados (apenas pr√≥prias notifica√ß√µes)

##### Response (200 OK)
```json
{
  "message": "Notification deleted successfully"
}
```

#### Delete All Read Notifications
**DELETE** `/notifications/read/all`

**Permiss√µes**: Usu√°rios autenticados

##### Response (200 OK)
```json
{
  "count": 8,
  "message": "8 read notification(s) deleted"
}
```

---

### **Para Admins e Funcion√°rios**

#### Create Single Notification
**POST** `/notifications`

**Permiss√µes**: `ADMIN` e `EMPLOYEE`

##### Request Body
```json
{
  "recipientId": "user_789",
  "type": "SYSTEM_ANNOUNCEMENT",
  "title": "Manuten√ß√£o Programada",
  "message": "Sistema entrar√° em manuten√ß√£o √†s 02:00 de amanh√£.",
  "data": {
    "maintenanceDate": "2024-01-16T02:00:00.000Z",
    "duration": "2 horas"
  },
  "actionUrl": "/system/maintenance",
  "priority": "HIGH",
  "expiresAt": "2024-01-16T06:00:00.000Z"
}
```

**üìù Observa√ß√µes sobre campos:**
- `data`: Aceita objeto JSON (n√£o precisa ser string)
- `actionUrl`: Aceita URLs absolutas ou relativas (ex: "/system/maintenance", "https://example.com")
- `expiresAt`: Data/hora em formato ISO 8601

##### Response (201 Created)
```json
{
  "id": "notif_890",
  "recipientId": "user_789",
  "type": "SYSTEM_ANNOUNCEMENT",
  "title": "Manuten√ß√£o Programada",
  "message": "Sistema entrar√° em manuten√ß√£o √†s 02:00 de amanh√£.",
  "data": {
    "maintenanceDate": "2024-01-16T02:00:00.000Z",
    "duration": "2 horas"
  },
  "isRead": false,
  "actionUrl": "/system/maintenance",
  "priority": "HIGH",
  "expiresAt": "2024-01-16T06:00:00.000Z",
  "createdAt": "2024-01-15T14:30:00.000Z",
  "updatedAt": "2024-01-15T14:30:00.000Z"
}
```

#### Create Bulk Notifications
**POST** `/notifications/bulk`

**Permiss√µes**: `ADMIN` e `EMPLOYEE`

##### Request Body
```json
{
  "notifications": [
    {
      "recipientId": "user_123",
      "type": "SYSTEM_ANNOUNCEMENT",
      "title": "Atualiza√ß√£o do Sistema",
      "message": "Nova vers√£o dispon√≠vel com melhorias.",
      "priority": "MEDIUM"
    },
    {
      "recipientId": "user_456",
      "type": "SYSTEM_ANNOUNCEMENT", 
      "title": "Atualiza√ß√£o do Sistema",
      "message": "Nova vers√£o dispon√≠vel com melhorias.",
      "priority": "MEDIUM"
    }
  ]
}
```

**‚ö†Ô∏è Campos Obrigat√≥rios para cada notifica√ß√£o:**
- `recipientId`: ID do usu√°rio destinat√°rio (obrigat√≥rio)
- `type`: Tipo da notifica√ß√£o (obrigat√≥rio) 
- `title`: T√≠tulo da notifica√ß√£o (obrigat√≥rio)
- `message`: Mensagem da notifica√ß√£o (obrigat√≥rio)

**üìù Campos Opcionais:**
- `priority`: Prioridade (padr√£o: "MEDIUM")
- `actionUrl`: URL de a√ß√£o
- `data`: Dados adicionais em JSON
- `expiresAt`: Data de expira√ß√£o

##### Response (201 Created)
```json
{
  "count": 2,
  "notifications": [
    {
      "id": "notif_901",
      "recipientId": "user_123",
      "type": "SYSTEM_ANNOUNCEMENT",
      "title": "Atualiza√ß√£o do Sistema",
      "message": "Nova vers√£o dispon√≠vel com melhorias.",
      "isRead": false,
      "priority": "MEDIUM",
      "createdAt": "2024-01-15T15:00:00.000Z"
    },
    {
      "id": "notif_902",
      "recipientId": "user_456",
      "type": "SYSTEM_ANNOUNCEMENT", 
      "title": "Atualiza√ß√£o do Sistema",
      "message": "Nova vers√£o dispon√≠vel com melhorias.",
      "isRead": false,
      "priority": "MEDIUM",
      "createdAt": "2024-01-15T15:00:00.000Z"
    }
  ]
}
```

#### Broadcast Notifications
**POST** `/notifications/broadcast`

**Permiss√µes**: `ADMIN` e `EMPLOYEE`

**Descri√ß√£o**: Envia uma notifica√ß√£o para todos os usu√°rios ativos de roles espec√≠ficos (broadcast).

##### Request Body
```json
{
  "targetRoles": ["CLIENT", "EMPLOYEE"],
  "type": "SYSTEM_ANNOUNCEMENT",
  "title": "Manuten√ß√£o Programada do Sistema",
  "message": "O sistema estar√° em manuten√ß√£o das 02:00 √†s 04:00 de amanh√£. Durante este per√≠odo, alguns servi√ßos poder√£o estar indispon√≠veis.",
  "data": {
    "maintenanceWindow": "2024-01-16T02:00:00.000Z - 2024-01-16T04:00:00.000Z",
    "affectedServices": ["dashboard", "api", "reports"]
  },
  "actionUrl": "/system/maintenance-info",
  "priority": "HIGH",
  "expiresAt": "2024-01-17T00:00:00.000Z"
}
```

**üìã Campos Obrigat√≥rios:**
- `targetRoles`: Array com os roles que receber√£o a notifica√ß√£o (`CLIENT`, `EMPLOYEE`, `ADMIN`)
- `type`: Tipo da notifica√ß√£o (obrigat√≥rio) 
- `title`: T√≠tulo da notifica√ß√£o (obrigat√≥rio)
- `message`: Mensagem da notifica√ß√£o (obrigat√≥rio)

**üéØ Roles Dispon√≠veis:**
- `CLIENT`: Apenas clientes
- `EMPLOYEE`: Apenas funcion√°rios  
- `ADMIN`: Apenas administradores
- `["CLIENT", "EMPLOYEE"]`: Clientes e funcion√°rios
- `["CLIENT", "EMPLOYEE", "ADMIN"]`: Todos os usu√°rios

##### Response (201 Created)
```json
{
  "message": "Broadcast notification sent to 25 users",
  "targetRoles": ["CLIENT", "EMPLOYEE"],
  "count": 25,
  "notifications": [
    {
      "id": "notif_123",
      "recipientId": "user_456",
      "type": "SYSTEM_ANNOUNCEMENT",
      "title": "Manuten√ß√£o Programada do Sistema",
      "message": "O sistema estar√° em manuten√ß√£o...",
      "isRead": false,
      "priority": "HIGH",
      "createdAt": "2024-01-15T20:30:00.000Z",
      "recipient": {
        "id": "user_456",
        "email": "cliente@exemplo.com",
        "role": "CLIENT",
        "profilePhoto": null
      }
    }
    // ... mais notifica√ß√µes
  ],
  "recipients": [
    {
      "id": "user_456",
      "email": "cliente@exemplo.com", 
      "role": "CLIENT"
    },
    {
      "id": "user_789",
      "email": "funcionario@exemplo.com",
      "role": "EMPLOYEE" 
    }
    // ... mais destinat√°rios
  ]
}
```

**‚úÖ Casos de Uso Comuns:**
- **Manuten√ß√£o do Sistema**: Notificar todos os usu√°rios sobre downtime
- **Novas Funcionalidades**: Anunciar updates para clientes
- **Pol√≠ticas da Empresa**: Comunicados internos para funcion√°rios
- **Alertas de Seguran√ßa**: Notifica√ß√µes cr√≠ticas para todos

**‚ö†Ô∏è Observa√ß√µes:**
- Apenas usu√°rios **ativos** (`isActive: true`) recebem as notifica√ß√µes
- Se nenhum usu√°rio for encontrado para os roles especificados, retorna `count: 0`
- Todas as notifica√ß√µes s√£o criadas em uma √∫nica transa√ß√£o para garantir consist√™ncia

---

## üõ†Ô∏è M√©todos Helper do Service

O `NotificationsService` inclui m√©todos helper para criar notifica√ß√µes espec√≠ficas:

### Service Request Notifications
```typescript
// Notificar aprova√ß√£o
await notificationsService.notifyServiceRequestApproved(
  'req_123', 
  'client_456', 
  'Website E-commerce'
);

// Notificar rejei√ß√£o  
await notificationsService.notifyServiceRequestRejected(
  'req_123',
  'client_456', 
  'Website E-commerce',
  'Informa√ß√µes insuficientes'
);
```

### Task Notifications
```typescript
// Notificar atribui√ß√£o de tarefa
await notificationsService.notifyTaskAssigned(
  'task_789',
  'employee_123',
  'Desenvolvimento da Landing Page'
);
```

### Payment Notifications
```typescript
// Notificar pagamento bem-sucedido
await notificationsService.notifyPaymentSuccess(
  'user_456',
  299.99,
  'Pacote Premium de cr√©ditos'
);

// Notificar cr√©ditos baixos
await notificationsService.notifyCreditsLow('user_456', 10);
```

### Campaign Notifications
```typescript
// Notificar atualiza√ß√£o de campanha
await notificationsService.notifyCampaignUpdate(
  'user_789',
  'campaign_123',
  'Black Friday 2024',
  'Campanha atualizada com novos produtos'
);

// Notificar campanha conclu√≠da
await notificationsService.notifyCampaignCompleted(
  'user_789',
  'campaign_123',
  'Black Friday 2024'
);
```

### File Management Notifications
```typescript
// Notificar arquivo adicionado √† biblioteca
await notificationsService.notifyLibraryFileAdded(
  'user_456',
  'documento-projeto.pdf',
  'library_file_789'
);

// Notificar arquivo removido
await notificationsService.notifyLibraryFileRemoved(
  'user_456',
  'documento-antigo.pdf'
);
```

### Security Notifications
```typescript
// Notificar altera√ß√£o de senha
await notificationsService.notifyPasswordChanged('user_456');

// Notificar tentativa de login suspeita
await notificationsService.notifyLoginAttempt(
  'user_456',
  'IP: 192.168.1.100'
);
```

### Chat Notifications
```typescript
// Notificar nova mensagem no chat
await notificationsService.notifyChatMessage(
  'user_456',
  'user_789',
  'chat_room_123',
  'Nova mensagem de Jo√£o Silva'
);

// Notificar men√ß√£o no chat
await notificationsService.notifyChatMention(
  'user_456',
  'user_789',
  'chat_room_123',
  'Voc√™ foi mencionado por Jo√£o Silva'
);
```

---

## üé® Integra√ß√£o Frontend

### 1. Hook para Notifica√ß√µes (React)
```tsx
import { useState, useEffect } from 'react';

interface Notification {
  id: string;
  type: string;
  title: string;
  message: string;
  isRead: boolean;
  priority: string;
  actionUrl?: string;
  createdAt: string;
}

interface NotificationStats {
  total: number;
  unread: number;
  read: number;
}

export const useNotifications = () => {
  const [notifications, setNotifications] = useState<Notification[]>([]);
  const [stats, setStats] = useState<NotificationStats | null>(null);
  const [loading, setLoading] = useState(true);

  const fetchNotifications = async (params?: any) => {
    try {
      const query = new URLSearchParams(params).toString();
      const response = await fetch(`/api/notifications?${query}`, {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      const data = await response.json();
      setNotifications(data.notifications);
      setLoading(false);
    } catch (error) {
      console.error('Error fetching notifications:', error);
      setLoading(false);
    }
  };

  const fetchStats = async () => {
    try {
      const response = await fetch('/api/notifications/stats', {
        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
      });
      const data = await response.json();
      setStats(data);
    } catch (error) {
      console.error('Error fetching stats:', error);
    }
  };

  const markAsRead = async (id: string) => {
    try {
      await fetch(`/api/notifications/${id}/read`, {
        method: 'PATCH',
        headers: { 
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        }
      });
      
      setNotifications(prev => 
        prev.map(notif => 
          notif.id === id ? { ...notif, isRead: true } : notif
        )
      );
      
      if (stats) {
        setStats(prev => ({
          ...prev!,
          unread: prev!.unread - 1,
          read: prev!.read + 1
        }));
      }
    } catch (error) {
      console.error('Error marking as read:', error);
    }
  };

  const markAllAsRead = async () => {
    try {
      await fetch('/api/notifications/mark-all-read', {
        method: 'PATCH',
        headers: { 
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'Content-Type': 'application/json'
        }
      });
      
      setNotifications(prev => 
        prev.map(notif => ({ ...notif, isRead: true }))
      );
      
      if (stats) {
        setStats(prev => ({
          ...prev!,
          unread: 0,
          read: prev!.total
        }));
      }
    } catch (error) {
      console.error('Error marking all as read:', error);
    }
  };

  useEffect(() => {
    fetchNotifications();
    fetchStats();
  }, []);

  return {
    notifications,
    stats,
    loading,
    fetchNotifications,
    fetchStats,
    markAsRead,
    markAllAsRead
  };
};
```

### 2. Componente de Notifica√ß√µes
```tsx
import React from 'react';
import { useNotifications } from './hooks/useNotifications';

const NotificationCenter: React.FC = () => {
  const { 
    notifications, 
    stats, 
    loading, 
    markAsRead, 
    markAllAsRead 
  } = useNotifications();

  if (loading) return <div>Carregando notifica√ß√µes...</div>;

  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case 'URGENT': return 'red';
      case 'HIGH': return 'orange';
      case 'MEDIUM': return 'blue';
      case 'LOW': return 'gray';
      default: return 'gray';
    }
  };

  const getTypeIcon = (type: string) => {
    switch (type) {
      case 'SERVICE_REQUEST_APPROVED': return '‚úÖ';
      case 'SERVICE_REQUEST_REJECTED': return '‚ùå';
      case 'SERVICE_REQUEST_ASSIGNED': return 'üìã';
      case 'SERVICE_REQUEST_COMPLETED': return 'üéâ';
      case 'TASK_ASSIGNED': return 'üìã';
      case 'TASK_COMPLETED': return '‚úÖ';
      case 'TASK_PROGRESS_UPDATE': return 'üìà';
      case 'CAMPAIGN_UPDATE': return 'üì¢';
      case 'CAMPAIGN_CREATED': return 'üéØ';
      case 'CAMPAIGN_COMPLETED': return 'üèÅ';
      case 'LIBRARY_FILE_ADDED': return 'üìÑ';
      case 'LIBRARY_FILE_REMOVED': return 'üóëÔ∏è';
      case 'LIBRARY_FILE_UPDATED': return 'üìù';
      case 'PASSWORD_CHANGED': return 'üîí';
      case 'ACCOUNT_LOCKED': return '‚õî';
      case 'LOGIN_ATTEMPT': return '‚ö†Ô∏è';
      case 'CHAT_MESSAGE': return 'üí¨';
      case 'CHAT_MESSAGE_MENTION': return 'üó®Ô∏è';
      case 'PAYMENT_SUCCESS': return 'üí≥';
      case 'PAYMENT_FAILED': return '‚ùå';
      case 'CREDITS_LOW': return '‚ö†Ô∏è';
      case 'CREDITS_ADJUSTMENT': return 'üí∞';
      case 'SYSTEM_ANNOUNCEMENT': return 'üì¢';
      case 'SYSTEM_MAINTENANCE': return 'üîß';
      default: return 'üîî';
    }
  };

  return (
    <div className="notification-center">
      <div className="notification-header">
        <h2>Notifica√ß√µes</h2>
        {stats && (
          <div className="notification-stats">
            <span className="unread-count">{stats.unread} n√£o lidas</span>
            <button onClick={markAllAsRead} disabled={stats.unread === 0}>
              Marcar todas como lidas
            </button>
          </div>
        )}
      </div>

      <div className="notification-list">
        {notifications.length === 0 ? (
          <p>Nenhuma notifica√ß√£o encontrada</p>
        ) : (
          notifications.map((notification) => (
            <div
              key={notification.id}
              className={`notification-item ${!notification.isRead ? 'unread' : ''}`}
              onClick={() => !notification.isRead && markAsRead(notification.id)}
            >
              <div className="notification-content">
                <div className="notification-header-item">
                  <span className="notification-icon">
                    {getTypeIcon(notification.type)}
                  </span>
                  <span className="notification-title">
                    {notification.title}
                  </span>
                  <span 
                    className="notification-priority"
                    style={{ color: getPriorityColor(notification.priority) }}
                  >
                    {notification.priority}
                  </span>
                </div>
                <p className="notification-message">
                  {notification.message}
                </p>
                <span className="notification-time">
                  {new Date(notification.createdAt).toLocaleString('pt-BR')}
                </span>
              </div>
              {!notification.isRead && (
                <div className="unread-indicator"></div>
              )}
            </div>
          ))
        )}
      </div>
    </div>
  );
};

export default NotificationCenter;
```

### 3. Componente de Badge de Notifica√ß√£o
```tsx
import React from 'react';
import { useNotifications } from './hooks/useNotifications';

const NotificationBadge: React.FC = () => {
  const { stats } = useNotifications();

  if (!stats || stats.unread === 0) {
    return <span className="notification-badge">üîî</span>;
  }

  return (
    <span className="notification-badge with-count">
      üîî
      <span className="notification-count">{stats.unread}</span>
    </span>
  );
};

export default NotificationBadge;
```

---

## üîß Configura√ß√µes Avan√ßadas

### Limpeza Autom√°tica de Notifica√ß√µes Expiradas

Voc√™ pode configurar um cron job para limpar notifica√ß√µes expiradas automaticamente:

```typescript
import { Injectable } from '@nestjs/common';
import { Cron, CronExpression } from '@nestjs/schedule';
import { NotificationsService } from './notifications.service';

@Injectable()
export class NotificationCronService {
  constructor(private notificationsService: NotificationsService) {}

  @Cron(CronExpression.EVERY_DAY_AT_MIDNIGHT)
  async cleanExpiredNotifications() {
    await this.notificationsService.cleanExpiredNotifications();
  }
}
```

### WebSocket para Notifica√ß√µes em Tempo Real

```typescript
// Em um gateway WebSocket
@WebSocketGateway()
export class NotificationsGateway {
  @WebSocketServer()
  server: Server;

  async sendNotificationToUser(userId: string, notification: any) {
    this.server.to(`user_${userId}`).emit('notification', notification);
  }
}
```

---

## üöÄ Pr√≥ximos Passos

1. **WebSocket Integration**: Implementar notifica√ß√µes em tempo real
2. **Push Notifications**: Adicionar suporte a notifica√ß√µes push no navegador
3. **Email Notifications**: Integrar com sistema de email para notifica√ß√µes importantes
4. **Templates**: Sistema de templates para diferentes tipos de notifica√ß√£o
5. **Analytics**: Dashboard para analytics de notifica√ß√µes

---

## üìù Notas de Implementa√ß√£o

- Todas as notifica√ß√µes expiradas s√£o automaticamente filtradas nas consultas
- O sistema suporta dados JSON customizados para cada notifica√ß√£o
- URLs de a√ß√£o s√£o opcionais e podem direcionar para p√°ginas espec√≠ficas
- O sistema √© otimizado para consultas r√°pidas com √≠ndices apropriados
- Suporte completo a pagina√ß√£o para grandes volumes de notifica√ß√µes

---

## üÜï Novos Tipos de Notifica√ß√£o Adicionados

### Resumo das Atualiza√ß√µes

O sistema de notifica√ß√µes foi expandido para incluir os seguintes tipos de notifica√ß√£o:

#### **Solicita√ß√µes de Servi√ßo**
- ‚úÖ `SERVICE_REQUEST_APPROVED` - Quando uma solicita√ß√£o de servi√ßo √© aprovada

#### **Avan√ßos em Tarefas e Workflow**
- üìà `TASK_PROGRESS_UPDATE` - Notifica sobre avan√ßos e progresso nas tarefas

#### **Campanhas**
- üì¢ `CAMPAIGN_UPDATE` - Atualiza√ß√µes gerais sobre campanhas
- üéØ `CAMPAIGN_CREATED` - Quando uma nova campanha √© criada
- üèÅ `CAMPAIGN_COMPLETED` - Quando uma campanha √© finalizada

#### **Gest√£o de Arquivos da Biblioteca**
- üìÑ `LIBRARY_FILE_ADDED` - Quando um arquivo √© adicionado √† biblioteca
- üóëÔ∏è `LIBRARY_FILE_REMOVED` - Quando um arquivo √© removido da biblioteca
- üìù `LIBRARY_FILE_UPDATED` - Quando um arquivo da biblioteca √© atualizado

#### **Seguran√ßa e Conta**
- üîí `PASSWORD_CHANGED` - Quando a senha do usu√°rio √© alterada
- ‚õî `ACCOUNT_LOCKED` - Quando uma conta √© bloqueada por raz√µes de seguran√ßa
- ‚ö†Ô∏è `LOGIN_ATTEMPT` - Notifica√ß√µes sobre tentativas de login suspeitas

#### **Comunica√ß√£o e Chat**
- üí¨ `CHAT_MESSAGE` - Nova mensagem recebida no chat
- üó®Ô∏è `CHAT_MESSAGE_MENTION` - Quando o usu√°rio √© mencionado em uma mensagem

### Implementa√ß√£o Recomendada

Para implementar estes novos tipos de notifica√ß√£o:

1. **Atualizar o Enum no Prisma Schema**: Adicionar os novos tipos no enum `NotificationType`
2. **Implementar Helper Methods**: Criar m√©todos helper no `NotificationsService` para cada tipo
3. **Configurar Triggers**: Configurar gatilhos autom√°ticos nos respectivos servi√ßos (campanhas, biblioteca, autentica√ß√£o, chat)
4. **Testar Integra√ß√£o**: Verificar se as notifica√ß√µes s√£o enviadas corretamente nos cen√°rios apropriados

### Exemplos de Uso nos Servi√ßos

```typescript
// No servi√ßo de campanhas
await this.notificationsService.notifyCampaignUpdate(
  userId, campaignId, campaignName, updateMessage
);

// No servi√ßo de biblioteca
await this.notificationsService.notifyLibraryFileAdded(
  userId, fileName, fileId
);

// No servi√ßo de autentica√ß√£o
await this.notificationsService.notifyPasswordChanged(userId);

// No servi√ßo de chat
await this.notificationsService.notifyChatMessage(
  recipientId, senderId, chatRoomId, messagePreview
);
```